<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Smart Stable Scheduler ‚Äî Portfolio Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#ffffff; --text:#0f1115; --muted:#5c6777; --panel:#f7f7f9; --border:#e4e7ec; --primary:#2563eb; --ok:#0a7f2e; --err:#b00020; }
  .dark  { --bg:#0f1115; --text:#e9eef5; --muted:#9aa4b2; --panel:#171a21; --border:#2a2f3a; --primary:#3b82f6; }
  * { box-sizing: border-box }
  body { margin: 20px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
  header { display:flex; font-size:24px; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
  header .brand { display:flex; gap:10px; align-items:center; }
  .emoji { font-size:34px }
  .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding:12px; margin-bottom:20px }
  .grid { display:grid; gap:12px }
  .grid.c2 { grid-template-columns: 1fr 1fr }
  .grid.c3 { grid-template-columns: repeat(3, 1fr) }
  label { font-size:12px; color: var(--muted); display:block; margin-bottom:4px }
  input, select { width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background: var(--bg); color: var(--text); }
  .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap }
  .btn { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background: var(--bg); cursor:pointer }
  .btn.primary { background: var(--primary); color: white; border-color: var(--primary) }
  .hint { font-size:12px; color: var(--muted) }
  .table { width:100%; border-collapse: collapse; font-size:14px; }
  .table th, .table td { border-top:1px solid var(--border); padding:8px; text-align:left; }
  .table th { color: var(--muted); font-weight:600; }
  /* Gantt */
  .gantt { border:1px solid var(--border); border-radius:12px; overflow:auto }
.g-inner { position: relative; }
.g-row { display:grid; grid-template-columns: 150px 1fr; border-top:1px solid var(--border) }
.g-row:first-child { border-top:0 }
.g-worker { background: var(--panel); padding: 6px 8px; border-right:1px solid var(--border);
            font-weight:600; font-size:12px; line-height:1.2 }
.g-lane { position:relative; height: 40px }               /* was 54px */
.g-task { position:absolute; top:8px; height: 24px;       /* was 34px */
          border-radius:6px; display:flex; align-items:center; padding:0 8px;
          white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
          border:1px solid rgba(0,0,0,.12); font-size:12px; line-height:1 }
.g-axis .g-lane { height: 26px }                          /* was 32px */
.g-tick { position:absolute; top:0; bottom:0; width:1px; background: var(--border) }
.g-ticklabel { position:absolute; top:4px; transform:translateX(-50%); font-size:11px; color: var(--muted) }
body {
  background: url("https://wallpapercave.com/wp/m3Oadrd.jpg") no-repeat center center fixed;
  background-size: cover;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: var(--text);
}
</style>
</head>
<body>
  <header>
    <div class="brand"><div class="emoji">üê¥</div><div><b>Smart Stable Scheduler</b><div class="hint">Constraint-aware scheduling</div></div></div>
    <label style="font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer;"><input id="themeToggle" type="checkbox"> Dark mode</label>
  </header>

  <div class="card">
    <div class="row">
      <label>Presets</label>
      <select id="preset">
        <option value="none">‚Äî choose ‚Äî</option>
        <option value="small">All Workers</option>
      </select>
      <button class="btn" id="loadPreset">Load</button>
      <button class="btn" id="clearAll">Clear All</button>
      <button class="btn primary" id="scheduleBtn">Schedule</button>
      <span id="status" class="hint"></span>
    </div>
    <div id="kpis" class="hint" style="margin-top:8px"></div>
  </div>

  <div class="grid c2">
    <div class="card">
      <h3>Workers</h3>
      <div class="grid c2">
        <div><label>Name</label><input id="wName" placeholder="Alice"></div>
        <div><label>Skills</label>
          <select id="wSkills" multiple size="4">
            <option value="feed">Feed</option>
            <option value="groom">Groom</option>
            <option value="exercise">Exercise</option>
            <option value="vet_assist">Vet/Farrier Assist</option>
          </select>
        </div>
        <div><label>Shift start</label><input id="wStart" type="time" value="09:00"></div>
        <div><label>Shift end</label><input id="wEnd" type="time" value="17:00"></div>
      </div>
      <div class="row"><button class="btn" id="addWorker">Add Worker</button></div>
      <table class="table" id="workersTable"><thead><tr><th>Name</th><th>Skills</th><th>Shift</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card">
      <h3>Tasks</h3>
      <div class="grid c3">
        <div><label>Horse</label><input id="tHorse" placeholder="h1"></div>
        <div><label>Type</label><select id="tType"><option>feed</option><option>groom</option><option>exercise</option><option>vet_assist</option></select></div>
        <div><label>Duration (min)</label><input id="tDur" type="number" value="30"></div>
        <div><label>Earliest start</label><input id="tStart" type="time" value="09:00"></div>
        <div><label>Latest finish</label><input id="tEnd" type="time" value="11:00"></div>
        <div><label>Priority (1‚Äì5)</label><input id="tPri" type="number" value="1" min="1" max="5"></div>
      </div>
      <div class="row"><button class="btn" id="addTask">Add Task</button></div>
      <table class="table" id="tasksTable"><thead><tr><th>ID</th><th>Type</th><th>Dur</th><th>Window</th><th>Pri</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card">
    <h3>Gantt</h3>
    <div id="gantt" class="gantt"></div>
  </div>

<script>
/* ===== Theme ===== */
const bodyEl=document.body, toggle=document.getElementById('themeToggle');
if(localStorage.getItem('sss-theme')==='dark'){ bodyEl.classList.add('dark'); toggle.checked=true; }
toggle.addEventListener('change',()=>{ bodyEl.classList.toggle('dark',toggle.checked); localStorage.setItem('sss-theme',toggle.checked?'dark':'light');});

/* ===== State ===== */
let workers=[], tasks=[];

/* ===== Helpers ===== */
const COLORS={feed:'#cfe8ff',groom:'#ffe3cf',exercise:'#daf5d7',vet_assist:'#f7d9e6'};
const toMin=t=>Math.floor(new Date(t).getTime()/60000);
const fromMin=m=>new Date(m*60000).toISOString();
function refreshTables(){
  document.querySelector('#workersTable tbody').innerHTML=workers.map(w=>`<tr><td>${w.name}</td><td>${w.skills.join(', ')}</td><td>${w.shift_start.split('T')[1]}‚Äì${w.shift_end.split('T')[1]}</td></tr>`).join('');
  document.querySelector('#tasksTable tbody').innerHTML=tasks.map(t=>`<tr><td>${t.id}</td><td>${t.type}</td><td>${t.duration_min}</td><td>${t.earliest_start.split('T')[1]}‚Äì${t.latest_finish.split('T')[1]}</td><td>${t.priority}</td></tr>`).join('');
}

/* ===== Adders ===== */
document.getElementById('addWorker').onclick=()=>{
  const id='w'+(workers.length+1);
  const name=document.getElementById('wName').value||id;
  const skills=Array.from(document.getElementById('wSkills').selectedOptions).map(o=>o.value);
  const start="2025-09-14T"+document.getElementById('wStart').value+":00";
  const end="2025-09-14T"+document.getElementById('wEnd').value+":00";
  workers.push({id,name,skills,shift_start:start,shift_end:end});
  refreshTables();
};
document.getElementById('addTask').onclick=()=>{
  const id='t'+(tasks.length+1);
  const horse=document.getElementById('tHorse').value||id;
  const type=document.getElementById('tType').value;
  const dur=parseInt(document.getElementById('tDur').value||'30');
  const start="2025-09-14T"+document.getElementById('tStart').value+":00";
  const end="2025-09-14T"+document.getElementById('tEnd').value+":00";
  const pri=parseInt(document.getElementById('tPri').value||'1');
  tasks.push({id,horse_id:horse,type,duration_min:dur,earliest_start:start,latest_finish:end,priority:pri});
  refreshTables();
};

/* ===== Scheduler (greedy) ===== */
function scheduleGreedy(req){
  const W=req.workers.map(w=>({...w,shiftStart:toMin(w.shift_start),shiftEnd:toMin(w.shift_end),nextFree:toMin(w.shift_start)}));
  const T=req.tasks.map(t=>({...t,est:toMin(t.earliest_start),lft:toMin(t.latest_finish),dur:+t.duration_min}));
  T.sort((a,b)=> (a.lft-b.lft) || (b.priority-a.priority));
  const assignments=[]; let tard=0, late=0;
  for(const t of T){
    let best=null;
    for(const w of W){
      if(!w.skills.includes(t.type)) continue;
      const s=Math.max(t.est,w.shiftStart,w.nextFree), e=s+t.dur;
      const score=(e>t.lft?1000:0)+(e-w.shiftStart); // prefer on-time then earlier end
      if(!best||score<best.score) best={w,s,e,score};
    }
    if(best){ best.w.nextFree=best.e; if(best.e>t.lft){tard+=best.e-t.lft; late++;} assignments.push({task_id:t.id,worker_id:best.w.id,start:fromMin(best.s),end:fromMin(best.e),_s:best.s,_e:best.e,_type:t.type}); }
    else assignments.push({task_id:t.id,worker_id:'(no skill)',start:t.earliest_start,end:t.earliest_start,_s:t.est,_e:t.est,_type:t.type,_unscheduled:true});
  }
  return {assignments,kpis:{total_tardiness_min:tard,on_time_rate:assignments.length?1-late/assignments.length:1}};
}

/* ===== Gantt ===== */
function drawGantt(req, res){
  const container = document.getElementById('gantt');
  container.innerHTML = '';
  if (!req) return;

  // --- Window: cover all selected workers' shifts + all assignments
  const startC = [], endC = [];
  for (const w of (req.workers||[])) {
    if (w.shift_start) startC.push(toMin(w.shift_start));
    if (w.shift_end)   endC.push(toMin(w.shift_end));
  }
  for (const a of (res.assignments||[])) {
    startC.push(a._s ?? toMin(a.start));
    endC.push(a._e ?? toMin(a.end));
  }
  const fallback = Math.floor(new Date().setHours(7,0,0,0)/60000);
  const windowStart = startC.length ? Math.min(...startC) : fallback;
  const windowEnd   = endC.length   ? Math.max(...endC)   : (fallback + 9*60);

  // --- Scale
  const PX_PER_MIN = 2;                      // adjust for zoom
  const spanMin = Math.max(1, windowEnd - windowStart);
  const innerWidthPx = spanMin * PX_PER_MIN;

  // --- Scrollable inner track
  const inner = document.createElement('div');
  inner.className = 'g-inner';
  inner.style.minWidth = innerWidthPx + 'px';
  container.appendChild(inner);

  // --- Axis
  const axis = document.createElement('div');
  axis.className = 'g-row g-axis';
  axis.innerHTML = `<div class="g-worker">Time</div><div class="g-lane"></div>`;
  const axisLane = axis.querySelector('.g-lane');
  const firstHour = Math.ceil(windowStart/60)*60;
  for (let m = firstHour; m <= windowEnd; m += 60) {
    const x = (m - windowStart) * PX_PER_MIN;
    axisLane.innerHTML += `
      <div class="g-tick" style="left:${x}px"></div>
      <div class="g-ticklabel" style="left:${x}px">
        ${new Date(m*60000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
      </div>`;
  }
  inner.appendChild(axis);

  // --- Ensure unique workers (no dup rows even if ids repeated)
  const uniqueWorkers = Array.from(new Map((req.workers||[]).map(w => [w.id, w])).values());

  // Pre-create lanes ONLY for the selected workers
  const laneByWorker = {};
  for (const w of uniqueWorkers) {
    const row = document.createElement('div'); row.className = 'g-row';
    row.innerHTML = `<div class="g-worker">${w.name || w.id}</div><div class="g-lane"></div>`;
    const lane = row.querySelector('.g-lane');
    inner.appendChild(row);
    laneByWorker[w.id] = lane;
  }

  // We'll add an "(unassigned)" lane ONLY if we actually need it
  let unassignedLane = null;
  function getUnassignedLane() {
    if (unassignedLane) return unassignedLane;
    const row = document.createElement('div'); row.className = 'g-row';
    row.innerHTML = `<div class="g-worker">(unassigned)</div><div class="g-lane"></div>`;
    unassignedLane = row.querySelector('.g-lane');
    inner.appendChild(row);
    return unassignedLane;
  }

  // --- Drop bars
  const assigns = res.assignments || [];
  for (const a of assigns) {
    const s = a._s ?? toMin(a.start);
    const e = a._e ?? toMin(a.end);
    const left  = (s - windowStart) * PX_PER_MIN;
    const width = Math.max(1, (e - s) * PX_PER_MIN);

    const type = a._type || (req.tasks.find(t => t.id === a.task_id)?.type) || 'task';
    const box = document.createElement('div');
    box.className = 'g-task';
    box.style.left = `${left}px`;
    box.style.width = `${width}px`;
    box.style.background = a._unscheduled ? '#f8d7da' : (COLORS[type] || '#ccc');
    box.title = `${a.task_id} (${type})`;
    box.textContent = `${a.task_id} ‚Ä¢ ${type}`;

    // Place bar on its worker's lane if present; otherwise into "(unassigned)" lane
    const lane = laneByWorker[a.worker_id] || (a._unscheduled ? getUnassignedLane() : getUnassignedLane());
    lane.appendChild(box);
  }

  // (Optional) auto-scroll to start
  container.scrollLeft = 0;
}


/* ===== Buttons ===== */
document.getElementById('scheduleBtn').onclick=()=>{
  const req={workers,tasks}; const res=scheduleGreedy(req);
  document.getElementById('status').textContent=' Done';
  document.getElementById('kpis').textContent=`On-time: ${(res.kpis.on_time_rate*100).toFixed(0)}% ‚Ä¢ Tardiness: ${res.kpis.total_tardiness_min} min`;
  drawGantt(req,res);
};
document.getElementById('clearAll').onclick=()=>{workers=[];tasks=[];refreshTables();document.getElementById('gantt').innerHTML='';};

/* ===== Presets ===== */
const PRESETS={
  small:{
    workers:[
      {id:"Alice",name:"Alice",skills:["Feed","Groom"],shift_start:"2025-09-14T09:00:00",shift_end:"2025-09-14T17:00:00"},
      {id:"Bob",name:"Bob",skills:["Exercise","Feed"],shift_start:"2025-09-14T09:00:00",shift_end:"2025-09-14T17:00:00"},
      {id:"Cora",name:"Cora",skills:["Groom","Vet Assist"],shift_start:"2025-09-14T08:00:00",shift_end:"2025-09-14T16:00:00"},
      {id:"Diego",name:"Diego",skills:["Feed", "Farrier Assist"],shift_start:"2025-09-14T06:30:00",shift_end:"2025-09-14T14:30:00"}
    ],
    tasks:[
      {id:"Task 1",horse_id:"Horse 1",type:"Feed",duration_min:30,earliest_start:"2025-09-14T09:00:00",latest_finish:"2025-09-14T11:00:00",priority:1},
      {id:"Task 2",horse_id:"Horse 2",type:"Groom",duration_min:60,earliest_start:"2025-09-14T10:00:00",latest_finish:"2025-09-14T14:00:00",priority:4},
      {id:"Task 3",horse_id:"Horse 3",type:"Exercise",duration_min:45,earliest_start:"2025-09-14T14:00:00",latest_finish:"2025-09-14T16:00:00",priority:3},
      {id:"Task 4",horse_id:"Horse 4",type:"Vet Assist",duration_min:60,earliest_start:"2025-09-14T07:30:00",latest_finish:"2025-09-14T09:00:00",priority:2},
      {id:"Task 5",horse_id:"Horse 5",type:"Farrier Assist",duration_min:60,earliest_start:"2025-09-14T09:30:00",latest_finish:"2025-09-14T12:00:00",priority:2}
    ]
  },
  busy:(()=>{
    const w=[
      {id:"Alice",name:"Alice",skills:["Feed","Groom"],shift_start:"2025-09-14T07:00:00",shift_end:"2025-09-14T15:00:00"},
      {id:"Ben",name:"Ben",skills:["Feed","Exercise"],shift_start:"2025-09-14T07:00:00",shift_end:"2025-09-14T15:00:00"},
      {id:"Cora",name:"Cora",skills:["Groom","Vet/Farrier Assist"],shift_start:"2025-09-14T08:00:00",shift_end:"2025-09-14T16:00:00"},
      {id:"Diego",name:"Diego",skills:["Feed"],shift_start:"2025-09-14T06:30:00",shift_end:"2025-09-14T14:30:00"}
    ];
    const base="2025-09-14T";
    const tasks=Array.from({length:12},(_,i)=>({
      id:`t${i+1}`,horse_id:`h${(i%6)+1}`,
      type:["Feed","Groom","Exercise", "Vet/Farrier Assist"][i%3],
      duration_min:[30,45,60][i%3],
      earliest_start:`${base}${String(7+(i%4)).padStart(2,'0')}:00:00`,
      latest_finish:`${base}${String(10+(i%4)).padStart(2,'0')}:30:00`,
      priority: (i%5)+1
    }));
    return {workers:w,tasks};
  })()
};
document.getElementById('loadPreset').onclick=()=>{
  const key=document.getElementById('preset').value;
  if(key==='none') return;
  workers=JSON.parse(JSON.stringify(PRESETS[key].workers));
  tasks=JSON.parse(JSON.stringify(PRESETS[key].tasks));
  refreshTables();
};

/* ===== Boot with small preset ===== */
workers=JSON.parse(JSON.stringify(PRESETS.small.workers));
tasks=JSON.parse(JSON.stringify(PRESETS.small.tasks));
refreshTables();
</script>
</body>
</html>
